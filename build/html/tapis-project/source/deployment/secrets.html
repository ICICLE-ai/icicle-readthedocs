<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Managing Secrets with SkAdmin &mdash; ICICLE-READTHEDOCS  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ICICLE-READTHEDOCS
              <img src="https://aiinstitutes.org/wp-content/uploads/2022/07/icicle.jpeg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">AI for CI-for-AI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/ICICLE_Foodshed_Parser.html">Constrained Language Models Yield Few-Shot Semantic Parsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/PPOD_CA.html">PPOD_CA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/Region2vec.html">Region2vec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/Species-Classification-Multimodal-Context.html">Species Classification using Multimodal Heterogeneous Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/Species-Classification-Multimodal-Context.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/Store_Closure_Website.html">Store_Closure_Website (Version 1)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ICICLE-READTHEDOCS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Managing Secrets with SkAdmin</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tapis-project/source/deployment/secrets.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="managing-secrets-with-skadmin">
<span id="secrets"></span><h1>Managing Secrets with SkAdmin<a class="headerlink" href="#managing-secrets-with-skadmin" title="Link to this heading"></a></h1>
<style> .red {color:#FF4136; font-weight:bold; font-size:20px} </style><hr class="docutils" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide is for users wanting to deploy Tapis software in their own datacenter. Researchers who
simply want to make use of the Tapis APIs do not need to deploy any Tapis components and can ignore
this guide.</p>
</div>
<section id="introduction-to-tapis-secrets">
<h2>Introduction to Tapis Secrets<a class="headerlink" href="#introduction-to-tapis-secrets" title="Link to this heading"></a></h2>
<p>Tapis stores all secrets that it uses or manages in <a class="reference external" href="vault.html">Hashicorp Vault</a>.  These secrets include:</p>
<ul class="simple">
<li><p>Service passwords</p></li>
<li><p>Database credentials</p></li>
<li><p>Signing key pairs</p></li>
<li><p>Credentials for user systems</p></li>
<li><p>Arbitrary passwords and other secrets</p></li>
</ul>
<p>The only Tapis runtime component that can access the Vault is the <a class="reference external" href="../technical/security.html">Security Kernal (SK)</a>.  There is, however, sometimes a need to read, write or delete secrets outside of SK, such as when installing or updating Tapis, rotating keys, or when manual action can quickly solve a problem.  The <a class="reference external" href="https://github.com/tapis-project/tapis-security/tree/dev/tapis-securitylib/src/main/java/edu/utexas/tacc/tapis/security/commands">SkAdmin</a> utility program provides such capabilities.</p>
</section>
<section id="the-skadmin-utility">
<h2>The SkAdmin Utility<a class="headerlink" href="#the-skadmin-utility" title="Link to this heading"></a></h2>
<p>The SkAdmin command line program manages secrets when Tapis is running or when it’s offline or only partially running, such as during start up.</p>
<p>SkAdmin does the following:</p>
<ul class="simple">
<li><p>Creates or updates secrets in SK.</p></li>
<li><p>Creates or updates secrets directly in Vault without going through SK.</p></li>
<li><p>Merges or replaces Kubernetes secrets with one or more values from SK.</p></li>
<li><p>Merges or replaces Kubernetes secrets with one or more values directly from Vault.</p></li>
<li><p>Generates passwords and key pairs on demand.</p></li>
<li><p>Provides summary and detail information about work performed on a run.</p></li>
</ul>
<p>Secret creation is independent of all Tapis services when going directly to Vault.  When used in this mode, the only dependencies are Vault and, possibly, Kubernetes.  This allows SkAdmin to bootstrap all secrets needed by Tapis before any services run.  Whether secrets are created by going through SK or by going directly to Vault, the same secret path naming conventions are used.</p>
<section id="packaging">
<h3>Packaging<a class="headerlink" href="#packaging" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://github.com/tapis-project/tapis-security/tree/dev/tapis-securitylib/src/main/java/edu/utexas/tacc/tapis/security/commands/SkAdmin.java">SkAdmin</a> is written in Java and resides in the <em>securitylib</em> repository.  <a class="reference external" href="https://github.com/tapis-project/tapis-security/blob/dev/tapis-securitylib/src/main/java/edu/utexas/tacc/tapis/security/commands/SkAdminParameters.java">SkAdminParameters</a> defines the supported command line parameters.</p>
<p>To run SkAdmin directly as a Java program, use the shaded JAR file, <em>shaded-securitylib.jar</em>.  For example, to see the help message, one would issue the following command from a terminal in which Java 17+ is configured and the JAR file is present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">cp</span> <span class="n">shaded</span><span class="o">-</span><span class="n">securitylib</span><span class="o">.</span><span class="n">jar</span> <span class="n">edu</span><span class="o">.</span><span class="n">utexas</span><span class="o">.</span><span class="n">tacc</span><span class="o">.</span><span class="n">tapis</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">SkAdmin</span> <span class="o">-</span><span class="n">help</span>
</pre></div>
</div>
<p>The most common way to run SkAdmin is using a docker container.  Here’s how to display the help message using docker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">--</span><span class="n">env</span> <span class="n">SKADMIN_PARMS</span><span class="o">=-</span><span class="n">help</span> <span class="n">tapis</span><span class="o">/</span><span class="n">securityadmin</span>
</pre></div>
</div>
<p>The value assigned to the container’s SKADMIN_PARMS environment variable is passed to SkAdmin on the command line.  See this <a class="reference external" href="https://github.com/tapis-project/tapis-security/blob/dev/deployment/tapis-securityadmin/Dockerfile">DockerFile</a> if you’re interested in how this is done.  Here is the SkAdmin help information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SkAdmin</span> <span class="k">for</span> <span class="n">creating</span> <span class="ow">and</span> <span class="n">deploying</span> <span class="n">secrets</span> <span class="n">to</span> <span class="n">Kubernetes</span><span class="o">.</span>

<span class="n">SkAdmin</span> <span class="p">[</span><span class="n">options</span><span class="o">...</span><span class="p">]</span>

<span class="o">-</span><span class="n">b</span> <span class="p">(</span><span class="o">-</span><span class="n">baseurl</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">base</span> <span class="n">sk</span> <span class="ow">or</span> <span class="n">vault</span> <span class="n">url</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">SK</span><span class="p">:</span> <span class="n">http</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="o">//</span><span class="n">host</span><span class="o">/</span><span class="n">v3</span><span class="p">,</span> <span class="n">Vault</span><span class="p">:</span> <span class="n">http</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="o">//</span><span class="n">host</span><span class="p">:</span><span class="mi">32342</span><span class="p">)</span>
<span class="o">-</span><span class="n">c</span> <span class="p">(</span><span class="o">-</span><span class="n">create</span><span class="p">)</span>                         <span class="p">:</span> <span class="n">create</span> <span class="n">secrets</span> <span class="n">that</span> <span class="n">don</span><span class="s1">&#39;t already exist (default: false)</span>
<span class="o">-</span><span class="n">dm</span> <span class="p">(</span><span class="o">-</span><span class="n">deployMerge</span><span class="p">)</span>                   <span class="p">:</span> <span class="n">deploy</span> <span class="n">secrets</span> <span class="n">to</span> <span class="n">kubernetes</span><span class="p">,</span> <span class="n">merge</span> <span class="k">with</span> <span class="n">existing</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">)</span>
<span class="o">-</span><span class="n">dr</span> <span class="p">(</span><span class="o">-</span><span class="n">deployReplace</span><span class="p">)</span>                 <span class="p">:</span> <span class="n">deploy</span> <span class="n">secrets</span> <span class="n">to</span> <span class="n">kubernetes</span><span class="p">,</span> <span class="n">replace</span> <span class="nb">any</span> <span class="n">existing</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">)</span>
<span class="o">-</span><span class="n">help</span> <span class="p">(</span><span class="o">--</span><span class="n">help</span><span class="p">)</span>                       <span class="p">:</span> <span class="n">display</span> <span class="n">help</span> <span class="n">information</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">true</span><span class="p">)</span>
<span class="o">-</span><span class="n">i</span> <span class="p">(</span><span class="o">-</span><span class="nb">input</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">file</span> <span class="n">path</span><span class="o">&gt;</span>              <span class="p">:</span> <span class="n">the</span> <span class="n">json</span> <span class="nb">input</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">folder</span>
<span class="o">-</span><span class="n">j</span> <span class="p">(</span><span class="o">-</span><span class="n">jwtenv</span><span class="p">)</span> <span class="n">VAL</span>                     <span class="p">:</span> <span class="n">JWT</span> <span class="n">environment</span> <span class="n">variable</span> <span class="n">name</span>
<span class="o">-</span><span class="n">kn</span> <span class="p">(</span><span class="o">-</span><span class="n">kubeNS</span><span class="p">)</span> <span class="n">VAL</span>                    <span class="p">:</span> <span class="n">kubernetes</span> <span class="n">namespace</span> <span class="n">to</span> <span class="n">be</span> <span class="n">accessed</span>
<span class="o">-</span><span class="n">kssl</span>                                <span class="p">:</span> <span class="n">validate</span> <span class="n">SSL</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">kubernetes</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">)</span>
<span class="o">-</span><span class="n">kt</span> <span class="p">(</span><span class="o">-</span><span class="n">kubeToken</span><span class="p">)</span> <span class="n">VAL</span>                 <span class="p">:</span> <span class="n">kubernetes</span> <span class="n">access</span> <span class="n">token</span> <span class="n">environment</span> <span class="n">variable</span> <span class="n">name</span>
<span class="o">-</span><span class="n">ku</span> <span class="p">(</span><span class="o">-</span><span class="n">kubeUrl</span><span class="p">)</span> <span class="n">VAL</span>                   <span class="p">:</span> <span class="n">kubernetes</span> <span class="n">API</span> <span class="n">server</span> <span class="n">URL</span>
<span class="o">-</span><span class="n">o</span> <span class="p">(</span><span class="o">-</span><span class="n">output</span><span class="p">)</span> <span class="n">VAL</span>                     <span class="p">:</span> <span class="s1">&#39;text&#39;</span> <span class="p">(</span><span class="n">default</span><span class="p">),</span> <span class="s1">&#39;json&#39;</span> <span class="ow">or</span> <span class="s1">&#39;yaml&#39;</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">text</span><span class="p">)</span>
<span class="o">-</span><span class="n">passwordlen</span> <span class="n">N</span>                       <span class="p">:</span> <span class="n">number</span> <span class="n">of</span> <span class="n">random</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">generated</span> <span class="n">passwords</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
<span class="o">-</span><span class="n">u</span> <span class="p">(</span><span class="o">-</span><span class="n">update</span><span class="p">)</span>                         <span class="p">:</span> <span class="n">create</span> <span class="n">new</span> <span class="n">secrets</span> <span class="ow">and</span> <span class="n">update</span> <span class="n">existing</span> <span class="n">ones</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">false</span><span class="p">)</span>
<span class="o">-</span><span class="n">vr</span> <span class="p">(</span><span class="o">-</span><span class="n">vaultRole</span><span class="p">)</span> <span class="n">VAL</span>                 <span class="p">:</span> <span class="n">vault</span> <span class="n">role</span><span class="o">-</span><span class="nb">id</span>
<span class="o">-</span><span class="n">vs</span> <span class="p">(</span><span class="o">-</span><span class="n">vaultSecret</span><span class="p">)</span> <span class="n">VAL</span>               <span class="p">:</span> <span class="n">vault</span> <span class="n">secret</span><span class="o">-</span><span class="nb">id</span>


<span class="n">Use</span> <span class="n">either</span> <span class="n">the</span> <span class="o">-</span><span class="n">c</span> <span class="ow">or</span> <span class="o">-</span><span class="n">u</span> <span class="n">option</span> <span class="n">to</span> <span class="n">change</span> <span class="n">secrets</span> <span class="ow">in</span> <span class="n">Vault</span><span class="o">.</span> <span class="n">Use</span> <span class="n">the</span> <span class="o">-</span><span class="n">dm</span>
<span class="ow">or</span> <span class="o">-</span><span class="n">dr</span> <span class="n">option</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">secrets</span> <span class="n">to</span> <span class="n">Kubernetes</span><span class="o">.</span>

<span class="n">Access</span> <span class="n">to</span> <span class="n">Vault</span> <span class="n">secrets</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">required</span><span class="o">.</span> <span class="n">Use</span> <span class="n">either</span> <span class="n">the</span> <span class="o">-</span><span class="n">j</span> <span class="n">option</span>
<span class="n">to</span> <span class="n">access</span> <span class="n">the</span> <span class="n">secrets</span> <span class="n">using</span> <span class="n">the</span> <span class="n">Security</span> <span class="n">Kernel</span> <span class="ow">or</span> <span class="n">the</span> <span class="p">{</span><span class="o">-</span><span class="n">vr</span><span class="p">,</span> <span class="o">-</span><span class="n">vs</span><span class="p">}</span> <span class="n">options</span>
<span class="n">to</span> <span class="n">accress</span> <span class="n">the</span> <span class="n">secrets</span> <span class="n">by</span> <span class="n">going</span> <span class="n">directly</span> <span class="n">to</span> <span class="n">Vault</span><span class="o">.</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">baseurl</span> <span class="n">to</span>
<span class="k">match</span> <span class="n">the</span> <span class="n">access</span> <span class="n">method</span><span class="o">.</span>  <span class="n">Set</span> <span class="n">the</span> <span class="p">{</span><span class="o">-</span><span class="n">kn</span><span class="p">,</span> <span class="o">-</span><span class="n">kt</span><span class="p">,</span> <span class="o">-</span><span class="n">ku</span><span class="p">}</span> <span class="n">options</span> <span class="n">when</span> <span class="n">deploying</span>
<span class="n">secrets</span> <span class="n">to</span> <span class="n">Kubernetes</span><span class="o">.</span>
</pre></div>
</div>
<p>We’ll use the containerized version of SkAdmin for the rest of this discussion.</p>
</section>
<section id="launching-skadmin">
<h3>Launching SkAdmin<a class="headerlink" href="#launching-skadmin" title="Link to this heading"></a></h3>
<p>To manage secrets, SkAdmin requires both of these parameters:</p>
<ul class="simple">
<li><p>-i (-input) - JSON file or directory containing one more JSON files that conform to the <a class="reference external" href="https://github.com/tapis-project/tapis-security/blob/dev/tapis-securitylib/src/main/resources/edu/utexas/tacc/tapis/security/jsonschema/SkAdminInput.json">SkAdminInput.json</a> schema.</p></li>
<li><p>-b (-baseurl) - the SK or Vault server url.</p></li>
</ul>
<p>And at least one of these <em>action</em> parameters:</p>
<ul class="simple">
<li><p>-c (-create) - create secrets only if they don’t already exist in Vault.</p></li>
<li><p>-u (-update) - write secrets to Vault even if they already exist.</p></li>
<li><p>-dm (-deployMerge) - write the specified key/value pairs to Kubernetes secrets, merging with unspecified key/value pairs that may exist in any secret.</p></li>
<li><p>-dr (-deplyReplace) - write the specified key/value pairs to Kubernetes secrets, completely replacing any secrets that may exist.</p></li>
</ul>
<p>The <em>-c</em> and <em>-u</em> parameters are mutually exclusive, as are the <em>-dm</em> and <em>-dr</em> parameters.  The <em>-c</em> option will never overwrite a secret that already exists in Vault, so it is non-destructive.  If the secret doesn’t exist, it will be created per the input file specification.  On the other hand, while the <em>-u</em> option also creates secrets if they don’t already exist in Vault, it will overwrite existing secrets according to the input file specification.  The <em>-u</em> option can be destructive.</p>
<p>The <em>-dm</em> option deploys secrets from Vault to Kubernetes secrets in an additive manner.  A Kubernetes secret can contain any number of key/value pairs.  The <em>-dm</em> option preserves existing key/value pairs and adds any new ones that exist in Vault; it therefore is non-destructive.  The <em>-dr</em> option, on the other hand, will replace all key/value pairs in a Kubernetes secret with the key/value pairs in Vault that are associated with the secret.  The <em>-dr</em> option can be destructive.</p>
<section id="vault-parameters">
<h4>Vault Parameters<a class="headerlink" href="#vault-parameters" title="Link to this heading"></a></h4>
<p>Both of the following parameters are required when accessing Vault directly.  Note that these parameters are mutually exclusive with the SK Parameters.</p>
<ul class="simple">
<li><p>-vr (-vaultRole) - the Vault role-id used to be acquire an authorized Vault token.</p></li>
<li><p>-vs (-vaultSecret) - the Vault secret-id used to be acquire an authorized Vault token.</p></li>
</ul>
<p>The role-id is the one assigned to the Security Kernel.  The secret-id is a short-lived secret, usually with a 10 minute TTL, that can be thought of as a temporary password associated with the role-id.  Details on how to obtain these values is beyond the scope of this discussion, but tapis-deployer’s <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/blob/main/playbooks/roles/skadmin/templates/kube/renew-sk-secret/renew-sk-secret-script">renew-sk-secret-script</a> provides an example implementation.</p>
</section>
<section id="sk-parameters">
<h4>SK Parameters<a class="headerlink" href="#sk-parameters" title="Link to this heading"></a></h4>
<p>If transactions are going to occur using SK rather than going directly to Vault, the following parameter is required.  Note that this parameter is mutually exclusive with all Vault Parameters.</p>
<ul class="simple">
<li><p>-j (-jwtenv) - the environment variable name whose value is a JWT authorized to access SK.</p></li>
</ul>
<p>The JWT is usually a Security Kernel service JWT.</p>
</section>
<section id="kubernetes-parameters">
<h4>Kubernetes Parameters<a class="headerlink" href="#kubernetes-parameters" title="Link to this heading"></a></h4>
<p>Kubernetes parameters are only required if a deployment to Kubernetes secrets has been specified (<em>-dm</em> or <em>-dr</em>).  All the following parameters are required to access Kubernetes.</p>
<ul class="simple">
<li><p>-kt (-kubeToken) - the environment variable name whose value contains an authorized Kubernetes token.</p></li>
<li><p>-ku (-kubeUrl) - the URL to the Kubernetes API server.</p></li>
<li><p>-kn (-kubeNS) - the Kubernetes namespace to access.</p></li>
</ul>
<p>SkAdmin uses these values to call the Kubernetes secrets API.</p>
</section>
<section id="general-parameters">
<h4>General Parameters<a class="headerlink" href="#general-parameters" title="Link to this heading"></a></h4>
<p>These parameters are optional and have default values.</p>
<ul class="simple">
<li><p>-o (-output) - output format can be one of text, json, or yaml.  The default is text.</p></li>
<li><p>-passwordlen - the length of generated passwords.  The default is 32.</p></li>
<li><p>-help (–help) - show the SkAdmin help message (no value necessary).</p></li>
</ul>
</section>
<section id="skadmin-inputs">
<h4>SkAdmin Inputs<a class="headerlink" href="#skadmin-inputs" title="Link to this heading"></a></h4>
<p>SkAdmin takes JSON input that conforms to the <a class="reference external" href="https://github.com/tapis-project/tapis-security/blob/dev/tapis-securitylib/src/main/resources/edu/utexas/tacc/tapis/security/jsonschema/SkAdminInput.json">SkAdminInput.json</a> schema.  The required <em>-i</em> parameter can name a single JSON file or a directory that contains any number of JSON files.  When a directory is specified, all JSON files that are immediate children of the directory are loaded and merged into a single set of secrets to be processed.</p>
<p>SkAdmin supports the following Security Kernel secret types:</p>
<ul class="simple">
<li><p>dbcredential - database credentials used by services</p></li>
<li><p>servicepwd - the password used by services to obtain their JWTs</p></li>
<li><p>jwtsigning - the asymmetric key pair used to sign and validate Tapis JWTs</p></li>
<li><p>jwtpublic - the public part of a jwtsigning key pair</p></li>
<li><p>user - arbitrary secret information associcated with a user</p></li>
</ul>
<p>A short discussion on secret types can be found in the Security Kernel <a class="reference external" href="../technical/security.html#secrets">secrets section</a>.  The input files used to generate Tapis’s initial set of secrets are in the <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/tree/main/playbooks/roles/skadmin/templates/kube/initialLoad">initialLoad</a> directory of <a class="reference external" href="https://github.com/tapis-project/tapis-deployer">tapis-deployer</a>.</p>
<p>The values of passwords and keys fields can be specified using the distinguished value “&lt;generate-secret&gt;”.  SkAdmin will generate random passwords or asymmetric key pairs as required.  The value of key fields can also be specified as “<a class="reference external" href="file:pathToPEMFile">file:pathToPEMFile</a>” where <em>pathToPEMFile</em> is a path, usually an absolute path, to a PEM file containing a public or private key.  Alternatively, key values can be provided inline in the input json files, in which case they are required to be in PEM format.</p>
<p>When SkAdmin is directed to generate a new key pair, both the public and private parts are saved in SK, but only the private part is deployed to Kubernetes using JwtSigning input.  To deploy the public key to Kubernetes, use separate JwtPublic input stanzas for each public key.</p>
<p>JwtPublic stanza can also be used independently of whether a key pair resides in SK.  If the optional publicKey value is provided in the JwtPublic input stanza, then that value will be used without consulting SK.  In addition, if that value starts with the “file:” string, the publicKey will be assigned the contents of the specified file.</p>
</section>
</section>
<section id="execution">
<h3>Execution<a class="headerlink" href="#execution" title="Link to this heading"></a></h3>
<p>SkAdmin execution consists of the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Validate parameters</strong> - Validate that a complete, non-conflicting set of parameters have be specified.  The API used to perform all I/O on the secrets database will be either the SK or Vault interface.</p></li>
<li><p><strong>Load secret specifications</strong> - The file or directory referenced by the <em>-input</em> parameter is loaded.  In the directory case, the JSON files in the directory are loaded in alphabetic order.  Each of the five secret types listed in the previous section are aggregated if there is more than one file.</p></li>
<li><p><strong>Validate secret specifications</strong> - All five types of secrets are validated.  If a value of <em>&lt;generate-secret&gt;</em> is encountered, then a password or key pair is generated depending on context.  Any invalid input causes the program to abort.</p></li>
<li><p><strong>Create or update secrets</strong> - If the <em>-create</em> parameter is set, then write the secrets to the Vault database only if they don’t already exist there.  If the <em>-update</em> parameter is set, always write the secrets to the Vault database.</p></li>
<li><p><strong>Deploy secrets</strong> - If the <em>-deployMerge</em> parameter is specified, then any new secret keys that do not already exist in Kubernetes secrets will be deployed.  If the <em>-deployReplace</em> parameter is specified, then all input secrets will be deployed to Kubernetes overwriting any existing secrets with the same name.</p></li>
<li><p><strong>Report results</strong> - SkAdmin writes a report with both summary and detail information to stdout in the format specified by the <em>-output</em> parameter.</p></li>
</ol>
<section id="result-reporting">
<h4>Result Reporting<a class="headerlink" href="#result-reporting" title="Link to this heading"></a></h4>
<p>An accounting of what actions were performed is printed to stdout when the program completes.  Summary information include counts of secrets processed.  Detailed information includes an outcome message for each secret action that includes success, failure and skipped outcomes.  The default result format is text, but json and yaml can also be specified.</p>
</section>
<section id="creating-secrets-with-skadmin">
<h4>Creating Secrets with SkAdmin<a class="headerlink" href="#creating-secrets-with-skadmin" title="Link to this heading"></a></h4>
<p>SkAdmin is an integral part of Tapis deployment processing:  It initializes Vault with Tapis roles and permissions, it creates secrets and, in Kubernetes environments, it deploys secrets to Kubernetes for subsequent injection into containers.</p>
<p>In an automated Kubernetes environment, SkAdmin would run in a pod, which complicates how values get passed to SkAdmin.  Consult the top-level deployer <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/blob/main/playbooks/roles/baseburnup/templates/kube/burnup">burnup</a> script to see when SkAdmin gets called during Tapis deployment and <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/blob/main/playbooks/roles/skadmin/templates/kube/burnup">skadmin/burnup</a> to see how parameters are passed into the SkAdmin pod.</p>
<p>For this discussion, however, we’ll show how to create secrets by running an SkAdmin docker container directly.  In the first scenario, we’ll go to your deployment’s <em>skadmin/initialLoad</em> directory, which contains the deployment’s initial secret specifications.  Here’s how we invoke SkAdmin to only create the secrets that do not already exist in Vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $TAPIS_DIR/tapis-kube/skadmin/initialLoad
docker run -e SKADMIN_PARMS=&quot;-c -i /initialLoad -vr &lt;VAULT_ROLEID&gt; -vs &lt;VAULT_SECRETID&gt; -b http://vault:8200&quot; --mount type=bind,source=`pwd`,target=/initialLoad --rm tapis/securityadmin
</pre></div>
</div>
<p>Going from left to right, we see that all the SkAdmin command line parameters are assigned to the SKADMIN_PARMS environment variable.  In this case, SkAdmin is being asked to create secrets only if they don’t already exist.  It will read the JSON files in the <em>/initialLoad</em> directory inside the container.</p>
<p>SkAdmin will communicate directly with Vault using values represented by &lt;VAULT_ROLEID&gt; and &lt;VAULT_SECRETID&gt; and the given Vault network location.  Details on how to obtain these values is beyond the scope of this discussion, but tapis-deployer’s <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/blob/main/playbooks/roles/skadmin/templates/kube/renew-sk-secret/renew-sk-secret-script">renew-sk-secret-script</a> provides an example implementation.</p>
<p>We bind mount the host’s current directory into the <em>/initialLoad</em> directory in the container.  Any host directory that contains SkAdmin JSON input files could serve as the source directory; any target directory in the container that’s referenced by the <em>-i</em> parameter could serve as the destination.  We use the <em>–rm</em> flag to instruct docker to remove the container (and any secrets it contains) after execution.</p>
</section>
<section id="creating-and-deploying-secrets-with-skadmin">
<h4>Creating and Deploying Secrets with SkAdmin<a class="headerlink" href="#creating-and-deploying-secrets-with-skadmin" title="Link to this heading"></a></h4>
<p>If we add Kubernetes parameters to the command line shown in the previous section, we’ll be able to both create secrets and deploy them to Kubernetes.  The changes begin at the <em>-dm</em> parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $TAPIS_DIR/tapis-kube/skadmin/initialLoad
docker run -e SKADMIN_PARMS=&quot;-c -i /initialLoad -vr &lt;VAULT_ROLEID&gt; -vs &lt;VAULT_SECRETID&gt; -b http://vault:8200&quot; --mount type=bind,source=`pwd`,target=/initialLoad --rm -dm -kt &lt;KUBE_TOKEN&gt; -kn &lt;KUBE_NAMESPACE&gt; -ku https://kubernetes.default.svc.cluster.local tapis/securityadmin
</pre></div>
</div>
<p>The <em>-dm</em> parameter instructs SkAdmin to merge the input secrets into Kubernetes secrets.  The merge will not change any secret value already in Kubernetes.  The &lt;KUBE_TOKEN&gt; and &lt;KUBE_NAMESPACE&gt; values allow access to the Kubernetes cluster running at the URL specified by the <em>-ku</em> parameter.</p>
</section>
<section id="updating-secrets-with-skadmin">
<h4>Updating Secrets with SkAdmin<a class="headerlink" href="#updating-secrets-with-skadmin" title="Link to this heading"></a></h4>
<p>It’s common to add a secret after Tapis has already been deployed, such as when a new service is added to a site.  The deployed SkAdmin directory contains an <a class="reference external" href="https://github.com/tapis-project/tapis-deployer/tree/main/playbooks/roles/skadmin/templates/kube/updateSecrets">updateSecrets</a> subdirectory that makes it easy make incremental changes to secrets in Vault and Kubernetes.  The <em>updateSecrets/README</em> file contents explain how to do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Adding</span> <span class="n">New</span> <span class="n">Secrets</span>
<span class="o">==================</span>

<span class="n">This</span> <span class="n">directory</span> <span class="n">contains</span> <span class="n">configuration</span> <span class="ow">and</span> <span class="n">script</span> <span class="n">files</span> <span class="n">that</span> <span class="n">allow</span> <span class="n">new</span> <span class="n">secrets</span> <span class="n">to</span> <span class="n">be</span> <span class="n">imported</span> <span class="n">into</span> <span class="n">SK</span> <span class="ow">and</span> <span class="n">Kubernetes</span><span class="o">.</span>  <span class="n">The</span> <span class="n">general</span> <span class="n">approach</span> <span class="n">follows</span> <span class="n">that</span> <span class="n">of</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">secrets</span> <span class="n">loading</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">directory</span><span class="o">.</span>  <span class="n">The</span> <span class="n">main</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">that</span> <span class="n">a</span> <span class="n">staging</span> <span class="n">directory</span> <span class="n">contains</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">SkAdmin</span> <span class="nb">input</span> <span class="n">files</span> <span class="n">specified</span> <span class="k">for</span> <span class="n">a</span> <span class="n">particular</span> <span class="n">run</span><span class="o">.</span>

<span class="n">Usage</span> <span class="ow">is</span> <span class="k">as</span> <span class="n">follows</span><span class="p">:</span>

   <span class="mf">1.</span> <span class="n">Put</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">SkAdmin</span> <span class="nb">input</span> <span class="n">json</span> <span class="n">files</span> <span class="n">into</span> <span class="n">the</span> <span class="o">./</span><span class="n">updateFiles</span> <span class="n">directory</span><span class="o">.</span>
   <span class="mf">2.</span> <span class="o">./</span><span class="n">burnup</span>
   <span class="mf">3.</span> <span class="n">Remove</span> <span class="n">your</span> <span class="n">json</span> <span class="n">files</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">staging</span> <span class="n">directory</span>

<span class="n">Common</span> <span class="n">use</span> <span class="n">cases</span> <span class="k">for</span> <span class="n">this</span> <span class="n">facility</span> <span class="n">include</span> <span class="n">creating</span> <span class="n">secrets</span> <span class="k">for</span> <span class="n">new</span> <span class="n">services</span><span class="p">,</span> <span class="n">generating</span> <span class="n">new</span> <span class="n">secrets</span> <span class="k">for</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">service</span> <span class="n">after</span> <span class="n">deleting</span> <span class="n">that</span> <span class="n">service</span><span class="s1">&#39;s secrets in SK, and restoring secrets in Kubernetes that exist in SK.</span>

<span class="n">This</span> <span class="n">facility</span> <span class="n">assumes</span> <span class="n">that</span> <span class="n">SK</span> <span class="n">was</span> <span class="n">previously</span> <span class="n">configured</span> <span class="ow">and</span> <span class="n">initialized</span> <span class="k">with</span> <span class="n">secrets</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">burnup</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">directory</span><span class="o">.</span>
</pre></div>
</div>
<section id="replacing-secrets">
<h5>Replacing Secrets<a class="headerlink" href="#replacing-secrets" title="Link to this heading"></a></h5>
<p>For safety, the process described in the above README calls SkAdmin with the create (<em>-c</em>) parameter just like in the two previous examples.  This means that the procedure is non-destructive to secrets in Vault and Kubernetes.  It also means the procedure cannot be used to replace existing secret values.</p>
<p>To replace an existing secret with a new one, follow these steps:</p>
<ol class="arabic simple">
<li><p>Use SK <a class="reference external" href="https://tapis-project.github.io/live-docs/?service=SK#tag/vault/operation/listSecretMeta">listSecret</a> and <a class="reference external" href="https://tapis-project.github.io/live-docs/?service=SK#tag/vault/operation/readSecret">readSecret</a> APIs to understand what secrets currently exist in SK.  Use <em>kubect get secret</em> calls to see what secrets are currently in Kubernetes and how SK maps them.  When new to this process, consider temporarily saving the secrets you plan to replace off to the side.</p></li>
<li><p>Run an SkAdmin container from the command line using the update (<em>-u</em>) and/or deployReplace (<em>-dr</em>) parameters and one input file at a time to limit potential loss.  SK saves up to 10 previous versions of a secret, so secrets are recoverable up to that limit.</p></li>
<li><p>Validate that everything went as expected and then delete any temporarily saved old secrets.</p></li>
</ol>
</section>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ICICLE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>